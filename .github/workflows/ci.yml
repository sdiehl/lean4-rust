name: CI
on:
  push:
    branches: [main, master]
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      CCACHE_DIR: ${{ github.workspace }}/.ccache
      CCACHE_COMPRESS: true
      CCACHE_MAXSIZE: 500M
    steps:
      - uses: actions/checkout@v4

      - uses: DeterminateSystems/nix-installer-action@main

      # Cache the Nix store - this is the big one for nix builds
      - uses: DeterminateSystems/magic-nix-cache-action@main

      # Cache ccache for C++ compilation
      - name: Restore ccache
        uses: actions/cache/restore@v4
        with:
          path: .ccache
          key: ccache-${{ runner.os }}-${{ hashFiles('src/**/*.cpp', 'src/**/*.h') }}
          restore-keys: |
            ccache-${{ runner.os }}-

      # Cache the build directory (stage0 + stage1 + all .olean files)
      # This is crucial - the Lean stdlib build takes most of the time
      - name: Restore build cache
        id: build-cache
        uses: actions/cache/restore@v4
        with:
          path: |
            build/release/stage0
            build/release/stage1
          key: build-${{ runner.os }}-${{ hashFiles('src/**/*.lean', 'src/**/*.cpp', 'src/**/*.h', 'CMakeLists.txt') }}
          restore-keys: |
            build-${{ runner.os }}-

      - name: Build
        run: |
          mkdir -p build/release
          cd build/release

          # Only run cmake if not cached or CMakeLists changed
          if [ ! -f CMakeCache.txt ]; then
            cmake ../.. --preset release -B .
          fi

          # Build stage1 (will be fast if .olean files are cached)
          make stage1 -j$(nproc)
        shell: nix develop -c bash -euxo pipefail {0}

      # Save caches after successful build
      - name: Save ccache
        uses: actions/cache/save@v4
        if: always()
        with:
          path: .ccache
          key: ccache-${{ runner.os }}-${{ hashFiles('src/**/*.cpp', 'src/**/*.h') }}

      - name: Save build cache
        uses: actions/cache/save@v4
        if: always()
        with:
          path: |
            build/release/stage0
            build/release/stage1
          key: build-${{ runner.os }}-${{ hashFiles('src/**/*.lean', 'src/**/*.cpp', 'src/**/*.h', 'CMakeLists.txt') }}

      - name: Compile Init.Core to bytecode
        run: |
          export LEAN_PATH="$(pwd)/build/release/stage1/lib/lean"
          ./build/release/stage1/bin/lean -Y /tmp/Init.Core.leanbc src/Init/Core.lean
          ls -la /tmp/Init.Core.leanbc
          SIZE=$(stat -c%s /tmp/Init.Core.leanbc)
          if [ "$SIZE" -lt 1000 ]; then
            echo "ERROR: Bytecode file is suspiciously small ($SIZE bytes)"
            exit 1
          fi
          echo "Successfully compiled Init.Core to bytecode ($SIZE bytes)"
        shell: nix develop -c bash -euxo pipefail {0}

      - name: Test VM backend Lake integration (build only)
        run: ./tests/vm-backend/run-build-tests.sh
        shell: nix develop -c bash -euxo pipefail {0}

      - name: Package
        run: |
          DATE=$(date +%d-%m-%Y)
          mkdir -p lean4-rust/bin lean4-rust/lib/lean
          cp -r build/release/stage1/bin/* lean4-rust/bin/
          # Copy only essential shared libraries (not .olean dirs or static libs)
          cp build/release/stage1/lib/lean/*.so lean4-rust/lib/lean/ 2>/dev/null || true
          cp build/release/stage1/lib/lean/*.dylib lean4-rust/lib/lean/ 2>/dev/null || true
          tar -czvf lean4-rust-${DATE}.tar.gz lean4-rust
          echo "RELEASE_DATE=${DATE}" >> $GITHUB_ENV

      - name: Release
        if: github.ref == 'refs/heads/master'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_DATE }}
          name: Build ${{ env.RELEASE_DATE }}
          files: lean4-rust-${{ env.RELEASE_DATE }}.tar.gz
          make_latest: true
